<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Superseed</title>
    <style>
        body { margin: 0; display: flex; justify-content: center; align-items: center; min-height: 100vh; background: #111; }
        #game-container { position: relative; }
        #ui { position: absolute; top: 10px; left: 10px; color: #0f0; font-family: monospace; }
        #tooltip { position: absolute; color: #0f0; background: rgba(0, 0, 0, 0.8); padding: 5px; display: none; }
        #mutation-menu { position: absolute; top: 10px; right: 10px; color: #0f0; background: rgba(0, 0, 0, 0.8); padding: 10px; display: none; }
    </style>
</head>
<body>
    <div id="game-container">
        <div id="ui">
            <p>Energy: <span id="energy">50</span></p>
            <p>System Bloom: <span id="progress">0%</span></p>
            <p><button onclick="toggleMutationMenu()">Mutations</button></p>
        </div>
        <div id="tooltip"></div>
        <div id="mutation-menu">
            <h3>Mutations</h3>
            <ul id="mutation-list"></ul>
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/phaser@3.55.2/dist/phaser.min.js"></script>
    <script>
        const config = {
            type: Phaser.AUTO,
            width: 800,
            height: 600,
            parent: 'game-container',
            scene: {
                preload: preload,
                create: create,
                update: update
            }
        };

        const game = new Phaser.Game(config);
        let scene, seed, components = [], energy = 50, progress = 0, energyRegen = 0.1, spreadCost = 10, spreadRange = 150;
        let antivirusActive = false, mutations = [], autoSpreadTimer = 0;

        function preload() {
            this.load.image('seed', 'https://via.placeholder.com/20/00ff00');
            this.load.image('seed2', 'https://via.placeholder.com/25/00cc00');
            this.load.image('component', 'https://via.placeholder.com/50/666666');
            this.load.image('bloomed', 'https://via.placeholder.com/50/00ff00');
            this.load.image('antivirus', 'https://via.placeholder.com/30/ff0000');
            this.load.audio('bloom', 'https://freesound.org/data/previews/270/270131_2018099-lq.mp3');
            this.load.audio('attack', 'https://freesound.org/data/previews/270/270129_2018099-lq.mp3');
        }

        function create() {
            scene = this; // Store the scene context
            const grid = [
                ['Power Supply', 'Motherboard', 'CPU'],
                ['RAM', 'GPU', 'Cooling Fan'],
                ['USB', 'Hard Drive', null]
            ];

            for (let y = 0; y < 3; y++) {
                for (let x = 0; x < 3; x++) {
                    if (grid[y][x]) {
                        let comp = scene.add.sprite(200 + x * 100, 200 + y * 100, 'component')
                            .setInteractive()
                            .setData('name', grid[y][x])
                            .setData('bloomed', false)
                            .setData('defended', false);
                        components.push(comp);
                        comp.on('pointerdown', () => trySpread(scene, comp));
                        comp.on('pointerup', (pointer) => { if (pointer.rightButtonReleased()) defendComponent(scene, comp); });
                        comp.on('pointerover', () => showTooltip(comp));
                        comp.on('pointerout', () => hideTooltip());
                    }
                }
            }

            seed = scene.add.sprite(200, 400, 'seed').setInteractive();
            seed.setData('bloomed', true);
            updateUI();

            scene.time.addEvent({ delay: 10000, callback: () => spawnAntivirus(scene), callbackScope: scene, loop: true });
            scene.sounds = {
                bloom: scene.sound.add('bloom'),
                attack: scene.sound.add('attack')
            };
        }

        function trySpread(scene, component) {
            if (energy >= spreadCost && !component.getData('bloomed')) {
                let distance = Phaser.Math.Distance.Between(seed.x, seed.y, component.x, component.y);
                if (distance <= spreadRange) {
                    energy -= spreadCost;
                    component.setTexture('bloomed');
                    component.setData('bloomed', true);
                    progress += 5;

                    scene.tweens.add({
                        targets: component,
                        scale: 1.2,
                        alpha: 0.8,
                        duration: 500,
                        yoyo: true,
                        onComplete: () => {
                            applyBonus(component);
                            scene.sounds.bloom.play();
                        }
                    });

                    if (progress >= 25 && seed.texture.key === 'seed') {
                        seed.setTexture('seed2');
                    }

                    if (component.getData('name') === 'Motherboard' && energy >= spreadCost) {
                        let nearby = components.filter(c => !c.getData('bloomed') && Phaser.Math.Distance.Between(component.x, component.y, c.x, c.y) <= spreadRange);
                        if (nearby.length > 0) trySpread(scene, nearby[0]);
                    }

                    updateUI();
                    seed.x = component.x;
                    seed.y = component.y;

                    if (progress >= 50 && !antivirusActive) antivirusActive = true;
                    if (progress >= 100) showEndScreen(scene, true);
                }
            }
        }

        function applyBonus(component) {
            const name = component.getData('name');
            switch (name) {
                case 'CPU': energyRegen = 0.3; break;
                case 'Power Supply': energy = Math.min(100, energy + 25); break;
                case 'RAM': spreadCost = 8; break;
                case 'GPU': component.setTint(0x00ff00); break;
                case 'Cooling Fan': spreadRange = 200; spreadCost = 15; break;
                case 'Motherboard': break;
                case 'Hard Drive':
                    if (!mutations.includes('Regen Boost')) mutations.push('Regen Boost');
                    else if (!mutations.includes('Auto-Spread')) mutations.push('Auto-Spread');
                    else if (!mutations.includes('AV Resistance')) mutations.push('AV Resistance');
                    updateMutationMenu();
                    break;
            }
        }

        function spawnAntivirus(scene) {
            if (antivirusActive && !mutations.includes('AV Resistance')) {
                let bloomed = components.filter(c => c.getData('bloomed') && !c.getData('defended'));
                if (bloomed.length > 0) {
                    let target = bloomed[Math.floor(Math.random() * bloomed.length)];
                    scene.add.sprite(target.x, target.y, 'antivirus').setDepth(1);
                    scene.sounds.attack.play();
                    scene.tweens.add({
                        targets: target,
                        alpha: 0.5,
                        duration: 1000,
                        onComplete: () => {
                            if (!target.getData('defended')) {
                                target.setTexture('component');
                                target.setData('bloomed', false);
                                progress -= 5;
                                updateUI();
                                if (progress < 10 && antivirusActive) showEndScreen(scene, false);
                            }
                        }
                    });
                }
            }
        }

        function defendComponent(scene, component) {
            if (energy >= 20 && component.getData('bloomed') && !component.getData('defended')) {
                energy -= 20;
                component.setData('defended', true);
                scene.tweens.add({
                    targets: component,
                    tint: 0x0000ff,
                    duration: 5000,
                    onComplete: () => component.setData('defended', false)
                });
                updateUI();
            }
        }

        function showTooltip(component) {
            let tooltip = document.getElementById('tooltip');
            let bonus = {
                'CPU': 'Faster Energy Regen',
                'Power Supply': '+25 Energy',
                'RAM': 'Cheaper Spread',
                'GPU': 'Visual Glow',
                'Cooling Fan': 'Longer Range, Higher Cost',
                'Motherboard': 'Multi-Spread',
                'Hard Drive': 'Unlocks Mutation'
            }[component.getData('name')] || 'No Bonus';
            tooltip.style.display = 'block';
            tooltip.style.left = `${component.x + 10}px`;
            tooltip.style.top = `${component.y + 10}px`;
            tooltip.textContent = `${component.getData('name')}: ${bonus}`;
        }

        function hideTooltip() {
            document.getElementById('tooltip').style.display = 'none';
        }

        function toggleMutationMenu() {
            let menu = document.getElementById('mutation-menu');
            menu.style.display = menu.style.display === 'none' ? 'block' : 'none';
        }

        function updateMutationMenu() {
            let list = document.getElementById('mutation-list');
            list.innerHTML = '';
            mutations.forEach(m => {
                let li = document.createElement('li');
                li.textContent = m;
                list.appendChild(li);
            });
            updateUI();
        }

        function showEndScreen(scene, won) {
            scene.scene.pause();
            scene.add.text(400, 300, won ? 'Victory!\nSystem Fully Bloomed' : 'Game Over\nSystem Lost', {
                fontSize: '32px',
                color: '#0f0',
                align: 'center'
            }).setOrigin(0.5);
            scene.add.text(400, 400, 'Refresh to Restart', { fontSize: '16px', color: '#0f0' }).setOrigin(0.5);
        }

        function updateUI() {
            document.getElementById('energy').textContent = Math.floor(energy);
            document.getElementById('progress').textContent = `${progress}%`;
        }

        function update() {
            if (energy < 100) {
                energy += energyRegen + (mutations.includes('Regen Boost') ? 0.2 : 0);
                updateUI();
            }
            if (mutations.includes('Auto-Spread')) {
                autoSpreadTimer += 1 / 60;
                if (autoSpreadTimer >= 5) {
                    let unbloomed = components.filter(c => !c.getData('bloomed') && Phaser.Math.Distance.Between(seed.x, seed.y, c.x, c.y) <= spreadRange);
                    if (unbloomed.length > 0) trySpread(scene, unbloomed[0]);
                    autoSpreadTimer = 0;
                }
            }
        }
    </script>
</body>
</html>
